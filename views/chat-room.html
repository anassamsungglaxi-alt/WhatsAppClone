<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ø£Ù†Ø³ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù„Ù…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100%; width: 100%; background: #e5ddd5; 
            font-family: sans-serif; overflow: hidden; 
        }

        .app-container { 
            display: flex; flex-direction: column; 
            height: 100vh; max-width: 700px; margin: 0 auto; 
            background: #fff; position: relative; 
        }

        header { 
            background: #075E54; color: white; padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; 
            flex-shrink: 0; z-index: 100; 
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: Ù‡Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ */
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; 
            background: #e5ddd5; display: flex; 
            flex-direction: column; gap: 10px; 
            padding-bottom: 20px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
        .msg { 
            padding: 8px 12px; border-radius: 12px; max-width: 85%; 
            font-size: 15px; position: relative; word-wrap: break-word; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„ØµØ­ÙŠÙ†) */
        .meta { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; margin-top: 4px; color: #888; }
        .ticks { margin-right: 5px; font-weight: bold; }
        .seen { color: #34b7f1; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØªØ§Ø¨Ø©: Ø«Ø§Ø¨Øª Ø¥Ø¬Ø¨Ø§Ø±ÙŠ ØªØ­Øª flex-shrink: 0 */
        .footer-bar { 
            background: #f0f0f0; padding: 10px; 
            display: flex; align-items: center; gap: 8px; 
            flex-shrink: 0; border-top: 1px solid #ccc; 
            z-index: 100;
        }

        #input { 
            flex: 1; padding: 12px; border: none; 
            border-radius: 25px; font-size: 16px; outline: none; 
        }

        .btn-action { 
            background: #075E54; color: white; border: none; 
            width: 44px; height: 44px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; flex-shrink: 0; 
        }
        
        #mic-btn { background: #ea4335; }
        audio { width: 210px; height: 40px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø·Ø¨Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„Ø´Ø§Øª) */
        #call-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #111; z-index: 2000; display: none; flex-direction: column; 
        }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { 
            position: absolute; top: 20px; right: 20px; 
            width: 100px; height: 140px; border: 2px solid #fff; 
            border-radius: 8px; object-fit: cover; z-index: 2001; 
        }
        .call-btns { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; z-index: 2002; }
        .end-btn { background: #ff3b30; color: white; border: none; padding: 15px 35px; border-radius: 30px; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">â¬…</button>
            <span style="font-weight:bold;">Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button onclick="startCall()" title="Ø§ØªØµØ§Ù„" style="background:none; border:none; font-size:22px; cursor:pointer;">ğŸ“</button>
            <button onclick="clearChat()" title="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸ—‘ï¸</button>
        </div>
    </header>

    <div id="chat-box"></div>
    
    <div id="typing-status" style="height:18px; font-size:12px; color:#075E54; padding:0 15px; background:#e5ddd5; font-weight:bold;"></div>

    <form class="footer-bar" id="msg-form">
        <button type="button" id="mic-btn" class="btn-action" onclick="handleMic()">ğŸ¤</button>
        <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
        <button type="submit" class="btn-action">â¤</button>
    </form>

    <div id="call-screen">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="call-btns">
            <button class="end-btn" onclick="endCall()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const parts = window.location.pathname.split('/');
    const userId = parts[2];
    const friendId = parts[3];
    let mediaRecorder, chunks = [], localStream, peerConnection;
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    socket.emit('join', userId);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„ØµØ­ÙŠÙ†
    async function loadMessages() {
        const res = await fetch(`/api/messages/${userId}/${friendId}`);
        const msgs = await res.json();
        const box = document.getElementById('chat-box');
        
        box.innerHTML = msgs.map(m => {
            const mine = m.from == userId;
            const isAudio = m.text.startsWith('data:audio');
            const status = mine ? `<span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span>` : '';
            
            return `
                <div class="msg ${mine ? 'sent' : 'received'}">
                    ${isAudio ? `<audio controls src="${m.text}"></audio>` : `<div>${m.text}</div>`}
                    ${mine ? `<div class="meta">${status}</div>` : ''}
                </div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;

        if(msgs.some(m => m.to == userId && !m.seen)) {
            socket.emit('mark-seen', { userId, friendId });
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    document.getElementById('msg-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('input');
        if(!inp.value.trim()) return;
        socket.emit('send-msg', { from: userId, to: friendId, text: inp.value });
        inp.value = '';
    };

    // Ù…Ø¤Ø´Ø± ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†
    document.getElementById('input').oninput = () => {
        socket.emit('typing', { from: userId, to: friendId });
    };

    socket.on('user-typing', d => {
        if(d.from == friendId) {
            document.getElementById('typing-status').innerText = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...';
            setTimeout(() => document.getElementById('typing-status').innerText = '', 2000);
        }
    });

    socket.on('chat-seen', loadMessages);
    socket.on('new-msg', loadMessages);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ---
    async function startCall() {
        document.getElementById('call-screen').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
        peerConnection.onicecandidate = e => e.candidate && socket.emit('call-signal', { to: friendId, candidate: e.candidate });
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('call-signal', { to: friendId, offer });
    }

    socket.on('call-signal', async (data) => {
        if (data.offer) {
            if (!confirm("Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©.. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø±Ø¯ØŸ")) return;
            document.getElementById('call-screen').style.display = 'flex';
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            peerConnection.onicecandidate = e => e.candidate && socket.emit('call-signal', { to: friendId, candidate: e.candidate });
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('call-signal', { to: friendId, answer });
        } else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => {});
        }
    });

    function endCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(peerConnection) peerConnection.close();
        document.getElementById('call-screen').style.display = 'none';
    }

    // Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯
    async function handleMic() {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                reader.onloadend = () => socket.emit('send-msg', { from: userId, to: friendId, text: reader.result });
            };
            mediaRecorder.start();
            btn.innerText = "ğŸ›‘";
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤";
        }
    }

    // Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø§Øª
    async function clearChat() {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
            await fetch('/api/delete-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, friendId })
            });
            loadMessages();
        }
    }

    loadMessages();
</script>
</body>
</html>