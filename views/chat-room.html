<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ø£Ù†Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        /* Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‡Ø§ØªÙ: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ */
        html, body { 
            height: 100%; width: 100%; overflow: hidden; 
            background: #e5ddd5; font-family: sans-serif;
        }

        .app-container { 
            display: flex; flex-direction: column; 
            height: 100vh; height: -webkit-fill-available; /* Ø­Ù„ Ù„Ù„Ø£ÙŠÙÙˆÙ† ÙˆØ§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
            max-width: 700px; margin: 0 auto; background: #fff; position: relative; 
        }

        header { 
            background: #075E54; color: white; padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; 
            flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 10px;
            background: #e5ddd5;
        }

        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 15px; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }

        .meta { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; margin-top: 4px; color: #888; }
        .ticks.seen { color: #34b7f1; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØªØ§Ø¨Ø©: ÙŠØ¸Ù„ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
        .footer-bar { 
            background: #f0f0f0; padding: 10px; 
            display: flex; align-items: center; gap: 8px; 
            flex-shrink: 0; border-top: 1px solid #ccc;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* Ø¯Ø¹Ù… Ù†ÙˆØªØ´ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }

        #input { flex: 1; padding: 12px; border: none; border-radius: 25px; font-size: 16px; outline: none; }
        .btn-action { background: #075E54; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©: Ø·Ø¨Ù‚Ø© Ø¹Ù„ÙˆÙŠØ© ÙƒØ§Ù…Ù„Ø© */
        #call-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: none; flex-direction: column; 
        }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 110px; height: 150px; border: 2px solid #fff; border-radius: 10px; object-fit: cover; }
        .call-btns { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; }
        .end-btn { background: #ff3b30; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 16px; }
        
        audio { max-width: 200px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">â¬…</button>
            <span style="font-weight:bold;">Ø¯Ø±Ø¯Ø´Ø©</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button onclick="startCall()" style="background:none; border:none; font-size:22px; cursor:pointer;">ğŸ“</button>
            <button onclick="clearChat()" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸ—‘ï¸</button>
        </div>
    </header>

    <div id="chat-box"></div>
    <div id="typing-status" style="height:20px; font-size:12px; color:#075E54; padding:0 15px; font-weight:bold; background:#e5ddd5;"></div>

    <form class="footer-bar" id="msg-form">
        <button type="button" id="mic-btn" class="btn-action" onclick="handleMic()">ğŸ¤</button>
        <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
        <button type="submit" class="btn-action">â¤</button>
    </form>

    <div id="call-screen">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="call-btns">
            <button class="end-btn" onclick="endCall()">Ø¥Ù†Ù‡Ø§Ø¡</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const parts = window.location.pathname.split('/');
    const userId = parts[2];
    const friendId = parts[3];
    let mediaRecorder, chunks = [], localStream, peerConnection;
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    socket.emit('join', userId);

    async function loadMessages() {
        const res = await fetch(`/api/messages/${userId}/${friendId}`);
        const msgs = await res.json();
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => {
            const mine = m.from == userId;
            const isAudio = m.text.startsWith('data:audio');
            return `<div class="msg ${mine ? 'sent' : 'received'}">
                ${isAudio ? `<audio controls src="${m.text}"></audio>` : `<div>${m.text}</div>`}
                ${mine ? `<div class="meta"><span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span></div>` : ''}
            </div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
        if(msgs.some(m => m.to == userId && !m.seen)) socket.emit('mark-seen', { userId, friendId });
    }

    document.getElementById('msg-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('input');
        if(!inp.value.trim()) return;
        socket.emit('send-msg', { from: userId, to: friendId, text: inp.value });
        inp.value = '';
    };

    document.getElementById('input').oninput = () => socket.emit('typing', { from: userId, to: friendId });

    socket.on('user-typing', d => {
        if(d.from == friendId) {
            document.getElementById('typing-status').innerText = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...';
            setTimeout(() => document.getElementById('typing-status').innerText = '', 2000);
        }
    });

    socket.on('chat-seen', loadMessages);
    socket.on('new-msg', loadMessages);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (WebRTC) ---
    async function startCall() {
        document.getElementById('call-screen').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
        peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
        peerConnection.onicecandidate = e => e.candidate && socket.emit('call-signal', { to: friendId, candidate: e.candidate });

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('call-signal', { to: friendId, offer });
    }

    socket.on('call-signal', async (data) => {
        if (data.offer) {
            if (!confirm("Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©.. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø±Ø¯ØŸ")) return;
            document.getElementById('call-screen').style.display = 'flex';
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            peerConnection.onicecandidate = e => e.candidate && socket.emit('call-signal', { to: friendId, candidate: e.candidate });
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('call-signal', { to: friendId, answer });
        } else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e => {});
        }
    });

    function endCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(peerConnection) peerConnection.close();
        document.getElementById('call-screen').style.display = 'none';
    }

    async function handleMic() {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                reader.onloadend = () => socket.emit('send-msg', { from: userId, to: friendId, text: reader.result });
            };
            mediaRecorder.start();
            btn.innerText = "ğŸ›‘";
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤";
        }
    }

    async function clearChat() {
        if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
            await fetch('/api/delete-chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId})});
            loadMessages();
        }
    }

    loadMessages();
</script>
</body>
</html>