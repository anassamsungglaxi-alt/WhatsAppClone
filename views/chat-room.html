<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Pro - Anas</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; width: 100%; background: #e5ddd5; font-family: sans-serif; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 700px; margin: 0 auto; background: #fff; position: relative; }
        header { background: #075E54; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 100; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 15px; position: relative; word-wrap: break-word; }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #call-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border: 2px solid #fff; border-radius: 8px; object-fit: cover; z-index: 2001; }
        .call-btns { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; z-index: 2002; }
        .end-btn { background: #ff3b30; color: white; border: none; padding: 15px 35px; border-radius: 30px; font-weight: bold; cursor: pointer; }

        .footer-bar { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; border-top: 1px solid #ccc; }
        #input { flex: 1; padding: 12px; border: none; border-radius: 25px; font-size: 16px; outline: none; }
        .btn-action { background: #075E54; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        #mic-btn { background: #ea4335; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:20px;">â¬…</button>
            <span style="font-weight:bold;">Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©</span>
        </div>
        <div style="display:flex; gap:15px;">
            <button onclick="initiateCall()" style="background:none; border:none; font-size:22px;">ğŸ“</button>
            <button onclick="clearChat()" style="background:none; border:none; font-size:20px;">ğŸ—‘ï¸</button>
        </div>
    </header>

    <div id="chat-box"></div>
    <div id="typing-status" style="height:18px; font-size:12px; color:#075E54; padding:0 15px; font-weight:bold;"></div>

    <form class="footer-bar" id="msg-form">
        <button type="button" id="mic-btn" class="btn-action" onclick="handleMic()">ğŸ¤</button>
        <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
        <button type="submit" class="btn-action">â¤</button>
    </form>

    <div id="call-screen">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="call-btns">
            <button class="end-btn" onclick="endCall()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const [,,userId, friendId] = window.location.pathname.split('/');
    let localStream, peerConnection, mediaRecorder, chunks = [];
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    socket.emit('join', userId);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Øª
    async function loadMessages() {
        const msgs = await (await fetch(`/api/messages/${userId}/${friendId}`)).json();
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => {
            const mine = m.from == userId;
            return `<div class="msg ${mine ? 'sent' : 'received'}">${m.text.startsWith('data:audio') ? `<audio controls src="${m.text}"></audio>` : `<div>${m.text}</div>`}</div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('msg-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('input');
        if(!inp.value.trim()) return;
        socket.emit('send-msg', { from: userId, to: friendId, text: inp.value });
        inp.value = '';
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ ---
    async function setupPeer(isOffer) {
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // Ø±Ø¨Ø· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØ±Ø© ÙˆØµÙˆØª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        peerConnection.ontrack = e => {
            console.log("Ø§Ø³ØªÙ„Ù…Øª ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±!");
            document.getElementById('remoteVideo').srcObject = e.streams[0];
        };

        peerConnection.onicecandidate = e => {
            if (e.candidate) socket.emit('call-signal', { to: friendId, candidate: e.candidate });
        };
    }

    async function initiateCall() {
        document.getElementById('call-screen').style.display = 'flex';
        await setupPeer(true);
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('call-signal', { to: friendId, offer });
    }

    socket.on('call-signal', async (data) => {
        if (data.offer) {
            if (!confirm("Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† ØµØ¯ÙŠÙ‚Ùƒ.. Ø±Ø¯ØŸ")) return;
            document.getElementById('call-screen').style.display = 'flex';
            await setupPeer(false);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('call-signal', { to: friendId, answer });
        } else if (data.answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => {});
        }
    });

    function endCall() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        if(peerConnection) peerConnection.close();
        document.getElementById('call-screen').style.display = 'none';
    }

    async function handleMic() {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                reader.onloadend = () => socket.emit('send-msg', { from: userId, to: friendId, text: reader.result });
            };
            mediaRecorder.start();
            btn.innerText = "ğŸ›‘";
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤";
        }
    }

    socket.on('new-msg', loadMessages);
    loadMessages();
</script>
</body>
</html>