<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ø£Ù†Ø³</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø«Ø¨Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; width: 100%; background: #e5ddd5; font-family: sans-serif; overflow: hidden; position: fixed; }
        
        .main-wrapper { display: flex; flex-direction: column; height: 100dvh; max-width: 800px; margin: 0 auto; background: #fff; position: relative; width: 100%; }
        
        header { background: #075E54; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 100; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }
        
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; overflow-wrap: break-word; }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .meta { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; margin-top: 4px; }
        .ticks { margin-right: 4px; font-weight: bold; color: #888; }
        .ticks.seen { color: #34b7f1; }
        
        .input-bar { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; border-top: 1px solid #ccc; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        
        #input { flex: 1; padding: 12px 15px; border: none; border-radius: 25px; font-size: 16px; outline: none; background: #fff; }
        
        .action-btn { background: #075E54; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        
        #rec-btn { background: #ea4335; }
        .recording { animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); opacity: 0.7; } }
        
        audio { width: 220px; height: 45px; margin-top: 5px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #video-grid { position: relative; width: 100%; height: 70%; display: flex; justify-content: center; }
        video { width: 90%; height: 100%; border-radius: 15px; background: #222; object-fit: cover; }
        #local-video { width: 100px; height: 150px; position: absolute; bottom: 10px; right: 25px; border: 2px solid white; z-index: 2001; }
        .call-btns { margin-top: 30px; display: flex; gap: 20px; }
        .hangup { background: #ff3b30; padding: 15px 40px; border-radius: 30px; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }

        @media (min-width: 800px) { .main-wrapper { border-left: 1px solid #ddd; border-right: 1px solid #ddd; } }
    </style>
</head>
<body>

    <div id="call-overlay">
        <h3 id="call-info" style="margin-bottom: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <div id="video-grid">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="call-btns">
            <button class="hangup" onclick="endCall()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
        </div>
    </div>

    <div class="main-wrapper">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;">â¬…</button>
                <span style="font-weight:bold;">Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©</span>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button onclick="initCall('voice')" title="Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">ğŸ“</button>
                <button onclick="initCall('video')" title="Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">ğŸ“¹</button>
                <button onclick="clearChat()" title="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" style="background:none; border:none; font-size:22px; color:white; cursor:pointer;">ğŸ—‘ï¸</button>
            </div>
        </header>

        <div id="chat-box"></div>
        <div id="typing-box" style="height:20px; font-size:12px; color:#075E54; padding:0 15px; font-weight:bold; background:#e5ddd5;"></div>

        <form class="input-bar" id="msg-form" onsubmit="return false;">
            <button type="button" id="rec-btn" class="action-btn" onclick="toggleMic()">ğŸ¤</button>
            <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" class="action-btn" id="send-btn">â¤</button>
        </form>
    </div>

    <script>
        const socket = io();
        const parts = window.location.pathname.split('/');
        const userId = parts[2];
        const friendId = parts[3];
        let mediaRecorder, chunks = [];
        let pc, localStream;

        // Ø«Ø¨Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.body.style.height = window.visualViewport.height + 'px';
                window.scrollTo(0, 0);
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
            });
        }

        socket.emit('join', userId);

        async function load() {
            const res = await fetch(`/api/messages/${userId}/${friendId}`);
            const msgs = await res.json();
            const box = document.getElementById('chat-box');
            box.innerHTML = msgs.map(m => {
                const mine = m.from == userId;
                const status = mine ? `<div class="meta"><span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span></div>` : '';
                let body = m.text.startsWith('data:audio') ? `<audio controls src="${m.text}"></audio>` : `<div>${m.text}</div>`;
                return `<div class="msg ${mine ? 'sent' : 'received'}">${body}${status}</div>`;
            }).join('');
            box.scrollTop = box.scrollHeight;
            if(msgs.some(m => m.to == userId && !m.seen)) socket.emit('mark-seen', { userId, friendId });
        }

        document.getElementById('send-btn').onclick = () => {
            const inp = document.getElementById('input');
            if(!inp.value.trim()) return;
            socket.emit('send-msg', { from: userId, to: friendId, text: inp.value });
            inp.value = '';
            inp.focus();
        };

        document.getElementById('input').oninput = () => socket.emit('typing', { from: userId, to: friendId });
        socket.on('user-typing', d => { if(d.from == friendId) { document.getElementById('typing-box').innerText = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...'; setTimeout(() => document.getElementById('typing-box').innerText = '', 2000); }});

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª WebRTC ---
        const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        async function initCall(type) {
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('call-info').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
                document.getElementById('local-video').srcObject = localStream;
                
                pc = new RTCPeerConnection(iceConfig);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                pc.onicecandidate = e => { if(e.candidate) socket.emit('ice-candidate', { to: friendId, candidate: e.candidate }); };
                pc.ontrack = e => { document.getElementById('remote-video').srcObject = e.streams[0]; };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('call-user', { to: friendId, from: userId, offer, type });
            } catch(e) { alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ"); endCall(); }
        }

        socket.on('incoming-call', async (data) => {
            if(confirm(`Ù…ÙƒØ§Ù„Ù…Ø© ${data.type === 'video' ? 'ÙÙŠØ¯ÙŠÙˆ' : 'ØµÙˆØªÙŠØ©'} Ù…Ù† ØµØ¯ÙŠÙ‚Ùƒ.. Ù‡Ù„ ØªÙ‚Ø¨Ù„ØŸ`)) {
                document.getElementById('call-overlay').style.display = 'flex';
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: data.type === 'video' });
                document.getElementById('local-video').srcObject = localStream;

                pc = new RTCPeerConnection(iceConfig);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                pc.onicecandidate = e => { if(e.candidate) socket.emit('ice-candidate', { to: data.from, candidate: e.candidate }); };
                pc.ontrack = e => { document.getElementById('remote-video').srcObject = e.streams[0]; };

                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer-call', { to: data.from, answer });
            } else { socket.emit('end-call', { to: data.from }); }
        });

        socket.on('call-accepted', async (data) => { 
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            document.getElementById('call-info').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©";
        });
        socket.on('ice-candidate', async (data) => { if(pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); });
        socket.on('call-ended', () => { alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©"); endCall(false); });

        function endCall(notify = true) {
            if(notify) socket.emit('end-call', { to: friendId });
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(pc) pc.close();
            pc = null;
            document.getElementById('call-overlay').style.display = 'none';
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯
        async function toggleMic() {
            const btn = document.getElementById('rec-btn');
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                        reader.onloadend = () => socket.emit('send-msg', { from: userId, to: friendId, text: reader.result });
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                    btn.innerText = "ğŸ›‘"; btn.classList.add('recording');
                } catch(err) { alert("Ø§ÙØªØ­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§ÙŠÙƒ Ø£ÙˆÙ„Ø§Ù‹"); }
            } else {
                mediaRecorder.stop();
                btn.innerText = "ğŸ¤"; btn.classList.remove('recording');
            }
        }

        async function clearChat() {
            if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                await fetch('/api/delete-chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, friendId }) });
                load();
            }
        }

        socket.on('new-msg', () => load());
        socket.on('chat-seen', () => load());
        load();
    </script>
</body>
</html>