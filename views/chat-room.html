<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دردشة خاصة</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* منع أي ارتداد أو حركة غريبة في الموبايل */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; 
            position: fixed; /* يمنع الصفحة كلها من السحب */
            background: #e5ddd5;
            font-family: sans-serif;
        }

        .container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100%;
        }

        header { 
            background: #075E54; 
            color: white; 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            flex-shrink: 0; 
            z-index: 10;
        }

        /* تعديل منطقة الشات للسكرول الحر */
        #chat-box { 
            flex: 1; 
            overflow-y: scroll; /* إجبار السكرول */
            -webkit-overflow-scrolling: touch; /* سكرول ناعم جداً للأيفون */
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            touch-action: pan-y; /* يسمح فقط بالسكرول فوق وتحت ويمنع الارتداد */
        }

        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; font-size: 16px; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }

        #form { 
            background: #f0f0f0; 
            padding: 10px; 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            flex-shrink: 0;
            border-top: 1px solid #ccc;
        }

        #input { 
            flex: 1; 
            padding: 12px 18px; 
            border-radius: 25px; 
            border: 1px solid #ddd; 
            font-size: 16px; 
            outline: none;
        }

        #send { 
            background: #075E54; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 48px; 
            height: 48px; 
            font-size: 20px;
            flex-shrink: 0;
        }
        
        #status { font-size: 12px; color: #075E54; height: 18px; padding: 0 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:24px; cursor:pointer; margin-left:15px;">⬅</button>
            <span style="font-weight:bold;">الدردشة</span>
        </header>

        <div id="chat-box"></div>
        
        <div id="status"></div>

        <form id="form">
            <input type="text" id="input" placeholder="اكتب رسالة..." autocomplete="off">
            <button type="submit" id="send">➤</button>
        </form>
    </div>

    <script>
        const socket = io();
        const parts = window.location.pathname.split('/');
        const userId = parts[2];
        const friendId = parts[3];
        const box = document.getElementById('chat-box');

        socket.emit('join', userId);

        async function loadMsgs(isFirstLoad = false) {
            const res = await fetch(`/api/messages/${userId}/${friendId}`);
            const msgs = await res.json();
            
            box.innerHTML = msgs.map(m => `
                <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                    ${m.text}
                    <div style="text-align:left; font-size:10px; margin-top:3px; color:#999;">
                        ${m.from == userId ? (m.seen ? '<span style="color:#34b7f1">✔✔</span>' : '✔') : ''}
                    </div>
                </div>
            `).join('');

            // لو لسه فاتح الصفحة أو بعت رسالة، ينزل لتحت خالص
            if(isFirstLoad) {
                box.scrollTop = box.scrollHeight;
            }
        }

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = document.getElementById('input').value;
            if(!val) return;
            socket.emit('send-msg', { from: userId, to: friendId, text: val });
            document.getElementById('input').value = '';
            // بعد الإرسال ينزل لتحت
            setTimeout(() => box.scrollTop = box.scrollHeight, 100);
        };

        socket.on('new-msg', (msg) => {
            if(msg.from == friendId || msg.from == userId) {
                // بنحمل الرسايل بس مش بنجبر السكرول ينزل تحت إلا لو المستخدم أصلاً كان تحت
                const isAtBottom = box.scrollHeight - box.clientHeight <= box.scrollTop + 50;
                loadMsgs().then(() => {
                    if(isAtBottom) box.scrollTop = box.scrollHeight;
                });
            }
        });

        // تشغيل التحميل لأول مرة
        loadMsgs(true);
    </script>
</body>
</html>