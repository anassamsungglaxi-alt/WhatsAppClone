<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±Ø¯Ø´Ø©</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        .container { display: flex; flex-direction: column; height: 100%; width: 100%; background: #e5ddd5; }
        header { background: #075E54; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 80%; font-size: 16px; word-wrap: break-word; position: relative; }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; }
        .ticks { font-size: 10px; color: #999; margin-right: 5px; }
        .seen { color: #34b7f1 !important; }
        #form { display: flex; padding: 10px; background: #f0f0f0; gap: 8px; flex-shrink: 0; }
        #input { flex: 1; padding: 12px; border-radius: 20px; border: none; font-size: 16px; outline: none; }
        #send { background: #075E54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button onclick="history.back()" style="background:none; border:none; color:white; font-size:20px;">â¬…</button>
            <span id="chat-title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            <button onclick="clearChat()" style="background:none; border:none; color:white; font-size:12px;">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        </header>
        <div id="chat-box"></div>
        <div id="status" style="padding: 0 15px; color: green; font-size: 12px; height: 15px;"></div>
        <form id="form">
            <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" id="send">â¤</button>
        </form>
    </div>

    <script>
        const socket = io();
        const parts = window.location.pathname.split('/');
        const userId = parts[2];
        const friendId = parts[3];

        socket.emit('join', userId);

        async function loadMsgs() {
            const res = await fetch(`/api/messages/${userId}/${friendId}`);
            const msgs = await res.json();
            const box = document.getElementById('chat-box');
            box.innerHTML = msgs.map(m => `
                <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                    ${m.text}
                    <div style="text-align:left; height:10px;">
                        ${m.from == userId ? `<span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span>` : ''}
                    </div>
                </div>
            `).join('');
            box.scrollTop = box.scrollHeight;
            socket.emit('mark-seen', { userId, friendId });
        }

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = document.getElementById('input').value;
            if(!val) return;
            socket.emit('send-msg', { from: userId, to: friendId, text: val });
            document.getElementById('input').value = '';
        };

        document.getElementById('input').oninput = () => socket.emit('typing', { from: userId, to: friendId });

        socket.on('new-msg', (msg) => { if(msg.from == friendId || msg.from == userId) loadMsgs(); });
        socket.on('user-typing', (data) => {
            if(data.from == friendId) {
                document.getElementById('status').innerText = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...';
                setTimeout(() => document.getElementById('status').innerText = '', 2000);
            }
        });
        socket.on('chat-seen', () => loadMsgs());

        async function clearChat() {
            if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø´Ø§ØªØŸ')) {
                await fetch('/api/delete-chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId})});
                loadMsgs();
            }
        }

        loadMsgs();
    </script>
</body>
</html>