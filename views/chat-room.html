<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±Ø¯Ø´Ø© - Ø±ÙŠÙƒÙˆØ±Ø¯Ø§Øª</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; overflow: hidden; position: fixed; background: #e5ddd5; font-family: sans-serif; }
        .container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        header { background: #075E54; color: white; padding: 15px; display: flex; align-items: center; flex-shrink: 0; }
        
        #chat-box { flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch; padding: 15px; display: flex; flex-direction: column; gap: 10px; touch-action: pan-y; }
        
        .msg { padding: 10px; border-radius: 12px; max-width: 85%; font-size: 16px; word-wrap: break-word; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ Ø§Ù„ØµÙˆØªÙŠ */
        audio { max-width: 100%; height: 35px; margin-top: 5px; }

        #form { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; align-items: center; flex-shrink: 0; border-top: 1px solid #ccc; }
        #input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙƒØ´Ù† */
        .action-btn { background: #075E54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .rec-active { background: red !important; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:24px; margin-left:15px;">â¬…</button>
            <span>Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©</span>
        </header>

        <div id="chat-box"></div>
        
        <form id="form">
            <button type="button" id="mic-btn" class="action-btn">ðŸŽ¤</button>
            <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" id="send" class="action-btn">âž¤</button>
        </form>
    </div>

    <script>
        const socket = io();
        const parts = window.location.pathname.split('/');
        const userId = parts[2];
        const friendId = parts[3];
        const box = document.getElementById('chat-box');

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        let mediaRecorder;
        let audioChunks = [];
        const micBtn = document.getElementById('mic-btn');

        socket.emit('join', userId);

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„ØµÙˆØª)
        async function loadMsgs(isFirstLoad = false) {
            const res = await fetch(`/api/messages/${userId}/${friendId}`);
            const msgs = await res.json();
            
            box.innerHTML = msgs.map(m => {
                const isAudio = m.text.startsWith('data:audio');
                return `
                <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                    ${isAudio ? `<audio controls src="${m.text}"></audio>` : m.text}
                    <div style="text-align:left; font-size:10px; color:#999; margin-top:3px;">
                        ${m.from == userId ? (m.seen ? '<span style="color:#34b7f1">âœ”âœ”</span>' : 'âœ”') : ''}
                    </div>
                </div>`;
            }).join('');

            if(isFirstLoad) box.scrollTop = box.scrollHeight;
        }

        // Ù…Ù†Ø·Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
        micBtn.onclick = async () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob); 
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        socket.emit('send-msg', { from: userId, to: friendId, text: base64Audio });
                    };
                    micBtn.classList.remove('rec-active');
                    micBtn.innerText = 'ðŸŽ¤';
                };

                mediaRecorder.start();
                micBtn.classList.add('rec-active');
                micBtn.innerText = 'ðŸ›‘';
            } else {
                mediaRecorder.stop();
            }
        };

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = document.getElementById('input').value;
            if(!val) return;
            socket.emit('send-msg', { from: userId, to: friendId, text: val });
            document.getElementById('input').value = '';
            setTimeout(() => box.scrollTop = box.scrollHeight, 100);
        };

        socket.on('new-msg', (msg) => {
            if(msg.from == friendId || msg.from == userId) {
                loadMsgs().then(() => box.scrollTop = box.scrollHeight);
            }
        });

        loadMsgs(true);
    </script>
</body>
</html>