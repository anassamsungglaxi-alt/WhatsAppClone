<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø±Ø¯Ø´Ø© Ø£Ù†Ø³</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ© */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            height: 100%; width: 100%; background: #e5ddd5; 
            font-family: sans-serif; overflow: hidden; 
        }

        /* Ø­Ø§ÙˆÙŠØ© Ù…Ø±Ù†Ø© ØªÙ…Ù†Ø¹ Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .main-wrapper {
            display: flex; flex-direction: column; 
            height: 100vh; max-width: 800px; margin: 0 auto;
            background: #fff; position: relative;
        }

        header { 
            background: #075E54; color: white; padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; 
            flex-shrink: 0; z-index: 100;
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª: Ø³ÙƒØ±ÙˆÙ„ Ø°ÙƒÙŠ Ù„Ø§ ÙŠØªØ£Ø«Ø± Ø¨Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5;
            display: flex; flex-direction: column; gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆÙ…Ù†Ø¹ ØªÙ…Ø¯Ø¯ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¶ */
        .msg { 
            padding: 8px 12px; border-radius: 12px; max-width: 85%; 
            font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word; overflow-wrap: break-word; 
        }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„ØµØ­ÙŠÙ†) */
        .meta { display: flex; align-items: center; justify-content: flex-end; font-size: 11px; margin-top: 4px; }
        .ticks { margin-right: 4px; font-weight: bold; color: #888; }
        .ticks.seen { color: #34b7f1; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØªØ§Ø¨Ø©: Ø«Ø§Ø¨Øª ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        .input-bar { 
            background: #f0f0f0; padding: 10px; 
            display: flex; align-items: center; gap: 10px; 
            flex-shrink: 0; border-top: 1px solid #ccc;
        }

        #input { 
            flex: 1; padding: 12px 15px; border: none; 
            border-radius: 25px; font-size: 16px; outline: none;
        }

        .action-btn { 
            background: #075E54; color: white; border: none; 
            width: 45px; height: 45px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0;
        }

        #rec-btn { background: #ea4335; }
        .recording { animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); opacity: 0.7; } }

        audio { width: 220px; height: 45px; margin-top: 5px; }

        /* ØªÙƒÙŠÙŠÙ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
        @media (min-width: 800px) {
            .main-wrapper { border-left: 1px solid #ddd; border-right: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="location.href='/chat/'+userId" style="background:none; border:none; color:white; font-size:22px;">â¬…</button>
                <span style="font-weight:bold;">Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©</span>
            </div>
            <button onclick="clearChat()" title="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸ—‘ï¸</button>
        </header>

        <div id="chat-box"></div>

        <div id="typing-box" style="height:20px; font-size:12px; color:#075E54; padding:0 15px; font-weight:bold; background:#e5ddd5;"></div>

        <form class="input-bar" id="msg-form">
            <button type="button" id="rec-btn" class="action-btn" onclick="toggleMic()">ğŸ¤</button>
            <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" class="action-btn">â¤</button>
        </form>
    </div>

    <script>
        const socket = io();
        const parts = window.location.pathname.split('/');
        const userId = parts[2];
        const friendId = parts[3];
        let mediaRecorder, chunks = [];

        socket.emit('join', userId);

        async function load() {
            const res = await fetch(`/api/messages/${userId}/${friendId}`);
            const msgs = await res.json();
            const box = document.getElementById('chat-box');
            
            box.innerHTML = msgs.map(m => {
                const mine = m.from == userId;
                const status = mine ? `<div class="meta"><span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span></div>` : '';
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ ÙƒÙ€ Player ÙˆÙ„ÙŠØ³ ÙƒÙˆØ¯ Ù†ØµÙŠ
                let body = m.text.startsWith('data:audio') 
                    ? `<audio controls src="${m.text}"></audio>` 
                    : `<div>${m.text}</div>`;

                return `<div class="msg ${mine ? 'sent' : 'received'}">${body}${status}</div>`;
            }).join('');
            box.scrollTop = box.scrollHeight;

            if(msgs.some(m => m.to == userId && !m.seen)) socket.emit('mark-seen', { userId, friendId });
        }

        document.getElementById('msg-form').onsubmit = (e) => {
            e.preventDefault();
            const inp = document.getElementById('input');
            if(!inp.value.trim()) return;
            socket.emit('send-msg', { from: userId, to: friendId, text: inp.value });
            inp.value = '';
        };

        document.getElementById('input').oninput = () => socket.emit('typing', { from: userId, to: friendId });

        socket.on('user-typing', d => {
            if(d.from == friendId) {
                document.getElementById('typing-box').innerText = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...';
                setTimeout(() => document.getElementById('typing-box').innerText = '', 2000);
            }
        });

        async function toggleMic() {
            const btn = document.getElementById('rec-btn');
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const reader = new FileReader();
                    reader.readAsDataURL(new Blob(chunks, { type: 'audio/webm' }));
                    reader.onloadend = () => socket.emit('send-msg', { from: userId, to: friendId, text: reader.result });
                };
                mediaRecorder.start();
                btn.innerText = "ğŸ›‘"; btn.classList.add('recording');
            } else {
                mediaRecorder.stop();
                btn.innerText = "ğŸ¤"; btn.classList.remove('recording');
            }
        }

        async function clearChat() {
            if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                await fetch('/api/delete-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId, friendId })
                });
                load();
            }
        }

        socket.on('new-msg', () => load());
        socket.on('chat-seen', () => load());
        load();
    </script>
</body>
</html>