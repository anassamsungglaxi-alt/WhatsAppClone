<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ù†Ø³ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: #e5ddd5; font-family: sans-serif;
            overflow: hidden; /* ÙŠÙ…Ù†Ø¹ Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§ */
        }

        .container { display: flex; flex-direction: column; height: 100vh; width: 100%; }

        header { 
            background: #075E54; color: white; padding: 12px; 
            text-align: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ - Ø±Ø¬Ø¹ØªÙ‡ÙˆÙ„Ùƒ Ø¨Ø´ÙƒÙ„ Ø´ÙŠÙƒ */
        #add-friend-area {
            background: #fff; padding: 8px; display: flex; gap: 5px;
            border-bottom: 1px solid #ddd; flex-shrink: 0;
        }
        #friend-id-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #add-btn { background: #25D366; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ */
        #friends-list { 
            background: #fff; border-bottom: 1px solid #ddd; 
            max-height: 100px; overflow-x: auto; flex-shrink: 0;
            display: flex; align-items: center; padding: 5px;
        }
        #friends { display: flex; list-style: none; padding: 0; margin: 0; gap: 10px; }
        .friend-item { 
            background: #f0f0f0; padding: 8px 15px; border-radius: 20px;
            white-space: nowrap; font-size: 14px; position: relative; border: 1px solid #ddd;
        }

        /* Ø§Ù„Ø´Ø§Øª Ø¨ÙˆÙƒØ³ - Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
        #chat-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #chat-box { 
            flex: 1; 
            overflow-y: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            scroll-behavior: smooth; /* Ø³ÙƒØ±ÙˆÙ„ Ù†Ø§Ø¹Ù… */
            -webkit-overflow-scrolling: touch; /* Ø¯Ø¹Ù… Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø³Ù„Ø³ Ù„Ù„Ø£ÙŠÙÙˆÙ† ÙˆØ§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
        }

        .msg { padding: 10px 15px; margin: 5px 0; border-radius: 15px; max-width: 80%; font-size: 15px; line-height: 1.4; elevation: 1; }
        .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
        .ticks { font-size: 11px; margin-right: 5px; color: #999; }
        .seen { color: #34b7f1 !important; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        #message-form { 
            display: flex; padding: 10px; background: #f0f0f0; 
            flex-shrink: 0; align-items: center; border-top: 1px solid #ddd;
        }
        #message-input { 
            flex: 1; border: none; padding: 12px 15px; 
            border-radius: 25px; font-size: 16px; outline: none;
        }
        #send-btn { 
            background: #075E54; color: white; border: none; 
            width: 45px; height: 45px; border-radius: 50%; margin-right: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        .notify-dot { color: #25D366; font-weight: bold; margin-right: 4px; }
        #typing-status { color: #075E54; font-size: 12px; height: 18px; padding: 0 15px; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <header><h3>ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ù†Ø³ - Ø§Ù„Ù…Ø·ÙˆØ±</h3></header>
    
    <div id="add-friend-area">
        <input type="number" id="friend-id-input" placeholder="Ø§ÙƒØªØ¨ ID Ø§Ù„ØµØ¯ÙŠÙ‚ Ù‡Ù†Ø§...">
        <button id="add-btn" onclick="addFriend()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div id="friends-list">
        <ul id="friends"></ul>
    </div>

    <div id="chat-section">
        <div style="padding:8px; background:#eee; display:flex; justify-content:space-between; font-size:13px; border-bottom:1px solid #ddd;">
            <span id="active-chat-with">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙƒÙ„Ø§Ù…</span>
            <button onclick="clearChat()" style="color:red; border:none; background:none; cursor:pointer;">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ ğŸ—‘ï¸</button>
        </div>
        <div id="typing-status"></div>
        <div id="chat-box"></div>
        
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" id="send-btn">â¤</button>
        </form>
    </div>
</div>

<script>
    const socket = io();
    const userId = window.location.pathname.split('/').pop();
    let activeFriendId = null;

    socket.emit('join', userId);

    // Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„Ù€ ID
    async function addFriend() {
        const fId = document.getElementById('friend-id-input').value;
        if(!fId) return alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ù€ ID Ø£ÙˆÙ„Ø§Ù‹");
        const res = await fetch('/api/add-friend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, friendId: fId })
        });
        const data = await res.json();
        if(data.success) {
            alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById('friend-id-input').value = "";
            loadFriends();
        } else {
            alert("Ø§Ù„Ù€ ID Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù„Ø´Ø®Øµ Ù…Ø¶Ø§Ù Ø¹Ù†Ø¯Ùƒ ÙØ¹Ù„Ø§Ù‹");
        }
    }

    async function loadFriends() {
        const res = await fetch('/api/friends/' + userId);
        const friends = await res.json();
        document.getElementById('friends').innerHTML = friends.map(f => `
            <li class="friend-item">
                <span onclick="openChat('${f.id}', '${f.name}')" style="cursor:pointer;">
                    ${f.name} <span class="notify-dot" id="dot-${f.id}" style="display:none;">â—</span>
                </span>
                <button onclick="removeFriend('${f.id}')" style="color:red; border:none; background:none; margin-right:8px; cursor:pointer;">Ã—</button>
            </li>`).join('');
    }

    async function openChat(fId, fName) {
        activeFriendId = fId;
        document.getElementById('active-chat-with').innerText = "Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹: " + fName;
        document.getElementById('dot-' + fId).style.display = 'none';
        const res = await fetch(`/api/messages/${userId}/${fId}`);
        renderMessages(await res.json());
        socket.emit('mark-seen', { userId, friendId: fId });
    }

    function renderMessages(msgs) {
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => `
            <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                ${m.text}
                <div style="text-align:left; height:10px;">
                    ${m.from == userId ? `<span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span>` : ''}
                </div>
            </div>`).join('');
        // Ø³ÙƒØ±ÙˆÙ„ Ù„ØªØ­Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('message-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if(!activeFriendId || !input.value) return;
        socket.emit('send-msg', { from: userId, to: activeFriendId, text: input.value });
        input.value = '';
    };

    document.getElementById('message-input').oninput = () => {
        if(activeFriendId) socket.emit('typing', { from: userId, to: activeFriendId });
    };

    socket.on('new-msg', (msg) => {
        if (activeFriendId && (msg.from == activeFriendId || msg.from == userId)) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙˆØ±Ø§Ù‹
            fetch(`/api/messages/${userId}/${activeFriendId}`)
                .then(res => res.json())
                .then(msgs => renderMessages(msgs));
        } else if (msg.from != userId) {
            document.getElementById('dot-' + msg.from).style.display = 'inline-block';
        }
    });

    socket.on('user-typing', (data) => {
        if (data.from == activeFriendId) {
            document.getElementById('typing-status').innerText = "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...";
            setTimeout(() => document.getElementById('typing-status').innerText = "", 2000);
        }
    });

    socket.on('chat-seen', (data) => {
        if (activeFriendId == data.by) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµØ­ÙŠÙ† Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ ÙÙˆØ±Ø§Ù‹
            const ticks = document.querySelectorAll('.sent .ticks');
            ticks.forEach(t => { t.innerText = 'âœ”âœ”'; t.classList.add('seen'); });
        }
    });

    async function clearChat() {
        if(!activeFriendId) return;
        if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){
            await fetch('/api/delete-chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId:activeFriendId})});
            document.getElementById('chat-box').innerHTML = '';
        }
    }

    async function removeFriend(fId) {
        if(confirm('Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ')){
            await fetch('/api/remove-friend', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId:fId})});
            loadFriends();
        }
    }

    loadFriends();
</script>
</body>
</html>