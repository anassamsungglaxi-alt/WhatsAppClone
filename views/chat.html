<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ù†Ø³ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Ø£Ù‡Ù… Ø¬Ø²Ø¡: Ù…Ù†Ø¹ Ø£ÙŠ Ø¨Ø±ÙˆØ² Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø§Ø´Ø© */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø­Ø±ÙƒØ© */
            background-color: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØªØ£Ø®Ø° Ø·ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
        .container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            max-width: 100vw;
        }

        header { 
            background: #075E54; color: white; padding: 10px; 
            text-align: center; flex-shrink: 0; font-size: 14px;
        }

        /* Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© */
        .top-bar {
            background: #fff; padding: 10px; border-bottom: 1px solid #ddd; flex-shrink: 0;
        }
        .add-friend-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .add-friend-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        .add-friend-row button { background: #25D366; color: white; border: none; padding: 0 15px; border-radius: 5px; }

        #friends-list { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; 
            scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ */
        }
        #friends-list::-webkit-scrollbar { display: none; }
        
        .friend-item { 
            background: #eee; padding: 6px 12px; border-radius: 15px; 
            white-space: nowrap; font-size: 13px; display: flex; align-items: center; gap: 5px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chat-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: #e5ddd5; 
            overflow: hidden; /* ÙŠÙ…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        }

        .chat-header {
            padding: 8px 12px; background: #eee; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd;
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù‡Ù†Ø§ Ø¨Ø³ */
        #chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            gap: 8px;
        }

        .msg { 
            padding: 8px 12px; border-radius: 10px; max-width: 85%; 
            font-size: 15px; line-height: 1.4; word-wrap: break-word;
            position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .sent { background: #dcf8c6; align-self: flex-end; }
        .received { background: #fff; align-self: flex-start; }
        .ticks { font-size: 10px; color: #999; margin-right: 5px; }
        .seen { color: #34b7f1 !important; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø«Ø§Ø¨ØªØ© */
        #message-form { 
            display: flex; padding: 8px; background: #f0f0f0; 
            gap: 5px; flex-shrink: 0; align-items: center;
        }
        #message-input { 
            flex: 1; border: none; padding: 12px 15px; 
            border-radius: 20px; font-size: 16px; outline: none;
        }
        #send-btn { 
            background: #075E54; color: white; border: none; 
            width: 40px; height: 40px; border-radius: 50%; font-size: 18px;
        }
        
        #typing-status { height: 15px; font-size: 11px; color: #075E54; padding: 0 15px; }
    </style>
</head>
<body>
<div class="container">
    <header><h4 id="user-info">Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ (ID: ${userId})</h4></header>
    
    <div class="top-bar">
        <div class="add-friend-row">
            <input type="number" id="friend-id-input" placeholder="ID Ø§Ù„ØµØ¯ÙŠÙ‚">
            <button onclick="addFriend()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="friends-list"><ul id="friends" style="display:flex; list-style:none; gap:10px; padding:0;"></ul></div>
    </div>

    <div id="chat-section">
        <div class="chat-header">
            <span id="active-chat-with" style="font-weight:bold; font-size:13px;">Ø§Ø®ØªØ± Ø´Ø§Øª</span>
            <button onclick="clearChat()" style="color:red; border:none; background:none; font-size:12px;">Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª ğŸ—‘ï¸</button>
        </div>
        <div id="typing-status"></div>
        <div id="chat-box"></div>
        
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit" id="send-btn">â¤</button>
        </form>
    </div>
</div>

<script>
    const socket = io();
    const userId = window.location.pathname.split('/').pop();
    let activeFriendId = null;

    socket.emit('join', userId);
    document.getElementById('user-info').innerText = `Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ (ID: ${userId})`;

    async function addFriend() {
        const fId = document.getElementById('friend-id-input').value;
        const res = await fetch('/api/add-friend', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId, friendId: fId })
        });
        const data = await res.json();
        if(data.success) { loadFriends(); document.getElementById('friend-id-input').value=""; }
        else alert("ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }

    async function loadFriends() {
        const res = await fetch('/api/friends/' + userId);
        const friends = await res.json();
        document.getElementById('friends').innerHTML = friends.map(f => `
            <li class="friend-item" onclick="openChat('${f.id}', '${f.name}')">
                ${f.name} <span id="dot-${f.id}" style="color:#25D366; display:none;">â—</span>
            </li>`).join('');
    }

    async function openChat(fId, fName) {
        activeFriendId = fId;
        document.getElementById('active-chat-with').innerText = fName;
        document.getElementById('dot-' + fId).style.display = 'none';
        const res = await fetch(`/api/messages/${userId}/${fId}`);
        renderMessages(await res.json());
        socket.emit('mark-seen', { userId, friendId: fId });
    }

    function renderMessages(msgs) {
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => `
            <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                ${m.text}
                <div style="text-align:left; height:8px;">
                    ${m.from == userId ? `<span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span>` : ''}
                </div>
            </div>`).join('');
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('message-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if(!activeFriendId || !input.value) return;
        socket.emit('send-msg', { from: userId, to: activeFriendId, text: input.value });
        input.value = '';
    };

    document.getElementById('message-input').oninput = () => { if(activeFriendId) socket.emit('typing', { from: userId, to: activeFriendId }); };

    socket.on('new-msg', (msg) => {
        if (activeFriendId && (msg.from == activeFriendId || msg.from == userId)) {
            openChat(activeFriendId, document.getElementById('active-chat-with').innerText);
        } else if (msg.from != userId) {
            const dot = document.getElementById('dot-' + msg.from);
            if(dot) dot.style.display = 'inline-block';
        }
    });

    socket.on('user-typing', (data) => {
        if (data.from == activeFriendId) {
            document.getElementById('typing-status').innerText = "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...";
            setTimeout(() => document.getElementById('typing-status').innerText = "", 2000);
        }
    });

    socket.on('chat-seen', (data) => { if (activeFriendId == data.by) openChat(activeFriendId, document.getElementById('active-chat-with').innerText); });

    async function clearChat() {
        if(!activeFriendId) return;
        if(confirm('Ù…Ø³Ø­ØŸ')){
            await fetch('/api/delete-chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId:activeFriendId})});
            document.getElementById('chat-box').innerHTML = '';
        }
    }

    loadFriends();
</script>
</body>
</html>