<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø§Øª Ø£Ù†Ø³ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
    /* ØªØµÙÙŠØ± Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨Ù‚Ø§Ø´ ÙÙŠÙ‡ ÙØ±Ø§ØºØ§Øª */
    * { box-sizing: border-box; }
    body, html { 
        margin: 0; 
        padding: 0; 
        height: 100%; 
        width: 100%;
        overflow: hidden; /* Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙˆÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„Ù…ØªØµÙØ­ */
        font-family: sans-serif;
    }

    .container { 
        display: flex; 
        flex-direction: column; 
        height: 100vh; /* Ø·ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
        width: 100%; 
    }

    header { 
        background: #075E54; 
        color: white; 
        padding: 10px; 
        text-align: center;
        flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¥Ù†Ù‡ ÙŠØµØºØ± */
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ - Ø®Ù„ÙŠÙ†Ø§Ù‡Ø§ Ø¹Ø±Ø¶ÙŠØ© Ø¹Ø´Ø§Ù† ØªÙˆÙØ± Ù…Ø³Ø§Ø­Ø© */
    #friends-list { 
        background: #fff; 
        border-bottom: 1px solid #ddd; 
        max-height: 80px; 
        overflow-x: auto; /* Ø³Ø­Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¶ Ù„Ùˆ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙƒØªÙŠØ± */
        flex-shrink: 0;
    }
    #friends { 
        display: flex; 
        padding: 5px; 
        margin: 0; 
        list-style: none; 
    }
    .friend-item { 
        padding: 5px 10px; 
        background: #eee; 
        margin: 0 5px; 
        border-radius: 15px; 
        white-space: nowrap; /* Ù…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
        font-size: 13px;
    }

    #chat-section { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        background: #e5ddd5; 
        overflow: hidden; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙˆÙ„ ÙŠØ¨Ù‚Ø§ Ø¬ÙˆÙ‡ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆÙƒØ³ Ø¨Ø³ */
    }

    /* Ø£Ù‡Ù… Ø¬Ø²Ø¡: ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    #chat-box { 
        flex: 1; 
        overflow-y: scroll; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙÙˆÙ‚ ÙˆØªØ­Øª */
        -webkit-overflow-scrolling: touch; /* Ø³Ø­Ø¨ Ù†Ø§Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        padding: 15px; 
        display: flex; 
        flex-direction: column; 
    }

    .msg { 
        padding: 8px 12px; 
        margin: 5px 0; 
        border-radius: 10px; 
        max-width: 85%; 
        word-wrap: break-word; /* ÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø·ÙˆÙŠÙ„ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ø³Ø­Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¶ */
        font-size: 15px;
    }
    .sent { background: #dcf8c6; align-self: flex-end; }
    .received { background: #fff; align-self: flex-start; }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    #message-form { 
        display: flex; 
        padding: 10px; 
        background: #f0f0f0; 
        flex-shrink: 0; 
    }
    #message-input { 
        flex: 1; 
        border: none; 
        padding: 12px; 
        border-radius: 25px; 
        font-size: 16px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…ÙŠØ¹Ù…Ù„Ø´ Ø²ÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    }
    button[type="submit"] {
        background: #075E54;
        color: white;
        border: none;
        padding: 0 15px;
        margin-right: 5px;
        border-radius: 50%;
        font-size: 18px;
    }
</style>
</head>
<body>
<div class="container">
    <header><h3 id="display-name">ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ù†Ø³</h3></header>
    <div id="friends-list"><ul id="friends" style="list-style:none; padding:0;"></ul></div>
    <div id="chat-section">
        <div style="padding:5px; background:#f9f9f9; display:flex; justify-content:space-between;">
            <span id="active-chat-with">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚</span>
            <button onclick="clearChat()" style="color:red; border:none; background:none; cursor:pointer;">Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª ğŸ—‘ï¸</button>
        </div>
        <div id="typing-status"></div>
        <div id="chat-box"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
        </form>
    </div>
</div>

<script>
    const socket = io();
    const userId = window.location.pathname.split('/').pop();
    let activeFriendId = null;

    socket.emit('join', userId);

    async function loadFriends() {
        const res = await fetch('/api/friends/' + userId);
        const friends = await res.json();
        document.getElementById('friends').innerHTML = friends.map(f => `
            <li class="friend-item">
                <span onclick="openChat('${f.id}', '${f.name}')" style="cursor:pointer;">
                    ${f.name} <span class="notify-dot" id="dot-${f.id}">â—</span>
                </span>
                <button onclick="removeFriend('${f.id}')" style="color:red; border:none; background:none;">âŒ</button>
            </li>`).join('');
    }

    async function openChat(fId, fName) {
        activeFriendId = fId;
        document.getElementById('active-chat-with').innerText = "Ù…Ø¹: " + fName;
        document.getElementById('dot-' + fId).style.display = 'none';
        const res = await fetch(`/api/messages/${userId}/${fId}`);
        renderMessages(await res.json());
        socket.emit('mark-seen', { userId, friendId: fId });
    }

    function renderMessages(msgs) {
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => `
            <div class="msg ${m.from == userId ? 'sent' : 'received'}">
                ${m.text} ${m.from == userId ? `<span class="ticks ${m.seen ? 'seen' : ''}">${m.seen ? 'âœ”âœ”' : 'âœ”'}</span>` : ''}
            </div>`).join('');
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('message-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if(!activeFriendId || !input.value) return;
        socket.emit('send-msg', { from: userId, to: activeFriendId, text: input.value });
        input.value = '';
    };

    document.getElementById('message-input').oninput = () => { if(activeFriendId) socket.emit('typing', { from: userId, to: activeFriendId }); };

    socket.on('new-msg', (msg) => {
        if (activeFriendId && (msg.from == activeFriendId || msg.from == userId)) {
            openChat(activeFriendId, document.getElementById('active-chat-with').innerText.replace('Ù…Ø¹: ', ''));
        } else if (msg.from != userId) {
            document.getElementById('dot-' + msg.from).style.display = 'inline-block';
        }
    });

    socket.on('user-typing', (data) => {
        if (data.from == activeFriendId) {
            document.getElementById('typing-status').innerText = "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...";
            setTimeout(() => document.getElementById('typing-status').innerText = "", 2000);
        }
    });

    socket.on('chat-seen', (data) => { if (activeFriendId == data.by) openChat(activeFriendId, ""); });

    async function removeFriend(fId) {
        if(confirm('Ø­Ø°Ù Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ')){
            await fetch('/api/remove-friend', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId:fId})});
            loadFriends();
        }
    }

    async function clearChat() {
        if(confirm('Ù…Ø³Ø­ Ø§Ù„Ø´Ø§ØªØŸ')){
            await fetch('/api/delete-chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId, friendId:activeFriendId})});
            document.getElementById('chat-box').innerHTML = '';
        }
    }

    loadFriends();
</script>
</body>
</html>